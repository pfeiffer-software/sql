<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SQL Nexus – CSV → Tabellen → SQL</title>
  <style>
    /* ========= Modern UI (keine Funktionsänderung) ========= */
    :root{
      --bg: #f6f7fb;
      --bg2:#eef2ff;
      --card:#ffffff;
      --border:#e5e7eb;
      --text:#0f172a;
      --muted:#64748b;
      --accent:#4f46e5;
      --accent2:#22c55e;

      --shadow: 0 14px 35px rgba(2,6,23,.08);
      --radius: 18px;

      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Liberation Sans", sans-serif;
    }
    
    html[data-theme="dark"]{
      --accent:#f97316;
      --accent2:#22c55e;
      --bg:#0b1020;
      --bg2:#0b1020;
      --card:#0f172a;
      --border:#1f2937;
      --text:#e5e7eb;
      --muted:#94a3b8;
      --shadow: 0 14px 35px rgba(0,0,0,.45);
    }


    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(900px 500px at 12% -10%, var(--bg2), transparent 60%),
        radial-gradient(900px 500px at 95% 10%, rgba(79,70,229,.15), transparent 55%),
        var(--bg);
    }

    body{ overflow-x: hidden; }


    /* Topbar */
    header{
      position:sticky; top:0; z-index:30;
      backdrop-filter: blur(10px);
      background: color-mix(in oklab, var(--bg) 78%, transparent);
      border-bottom:1px solid var(--border);
    }
    .bar{
      max-width: 100%;
      margin:0 auto;
      padding:14px 22px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .brand{
      display:flex; align-items:center; gap:12px;
      min-width: 260px;
    }
    .logo{
      width:36px; height:36px; border-radius:12px;
      background:
        radial-gradient(circle at 30% 25%, rgba(255,255,255,.55), transparent 40%),
        linear-gradient(135deg, var(--accent), color-mix(in oklab, var(--accent) 40%, #06b6d4));
      box-shadow: 0 10px 24px rgba(79,70,229,.25);
    }
    .brand h1{
      font-size:15px; line-height:1.1; margin:0;
      letter-spacing:.2px;
    }
    .brand .sub{
      font-size:12px; color:var(--muted); margin-top:2px;
    }

    .actions{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    input[type="file"]{ display:none; }

    .btn{
      appearance:none;
      border:2px solid var(--border);
      background: color-mix(in oklab, var(--card) 92%, transparent);
      color:var(--text);
      border-radius: 12px;
      padding:10px 12px;
      font-size:13px;
      cursor:pointer;
      transition: transform .06s ease, box-shadow .2s ease, border-color .2s ease;
      user-select:none;
      display:inline-flex; align-items:center; gap:8px;
    }
    .btn:hover{
      border-color: color-mix(in oklab, var(--accent) 35%, var(--border));
      box-shadow: 0 10px 24px rgba(2,6,23,.06);
    }
    .btn:active{ transform: translateY(1px); }
    .btn:disabled{ opacity:.55; cursor:not-allowed; }
    .btn.primary{
      border-color: color-mix(in oklab, var(--accent) 35%, var(--border));
      background: linear-gradient(135deg,
        color-mix(in oklab, var(--accent) 18%, var(--card)),
        color-mix(in oklab, var(--accent) 8%, var(--card))
      );
    }
    .btn.danger{
      border-color: color-mix(in oklab, #ef4444 40%, var(--border));
      background: linear-gradient(135deg,
        color-mix(in oklab, #ef4444 14%, var(--card)),
        color-mix(in oklab, #ef4444 6%, var(--card))
      );
    }
    .btn.small{ padding:8px 10px; font-size:12px; border-radius: 11px; }

    .wrap{
      max-width: 100%;
      margin: 0 auto;
      padding:14px 22px 18px;
      display:grid;
      grid-template-columns: 340px 1fr;
      grid-template-rows: minmax(0, 1fr) minmax(240px, 1fr);

      grid-template-areas:
        "side control"
        "result result";
      gap: 14px;
      height: auto !important;          /* statt calc(100vh - 68px) */
      min-height: 0 !important;         /* statt 420px */
      align-content: start;
    }

    #sidePanel{ grid-area: side; }
    #controlPanel{ grid-area: control; }
    #resultPanel{ grid-area: result; }

    @media (max-width: 980px){
      .wrap{
        grid-template-columns: 1fr;
        grid-template-rows: auto auto 1fr;
        grid-template-areas:
          "side"
          "control"
          "result";
        height:auto;
      }
      .brand{ min-width: unset; }
    }
        

    .panel{
      background: color-mix(in oklab, var(--card) 95%, transparent);
      border:2px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
            box-shadow: var(--shadow), 0 0 0 1px color-mix(in oklab, var(--border) 70%, transparent);
overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height:0;
    }
    .panel .top{
      padding: 12px 14px;
      border-bottom:1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .panel .title{
      font-weight: 650;
      letter-spacing:.2px;
      font-size: 13.5px;
      display:flex; align-items:center; gap:8px;
    }
    .pill{
      font-size:12px;
      padding:4px 8px;
      border-radius:999px;
      border:2px solid var(--border);
      color:var(--muted);
      background: color-mix(in oklab, var(--card) 90%, transparent);
      white-space:nowrap;
    }
    .panel .content{
      padding: 12px 14px;
      overflow-y:auto;
      overflow-x:hidden;
      min-height:0;
    }
    .status{ font-size:12px; color:var(--muted); }
    .ok{ color: color-mix(in oklab, var(--accent2) 70%, var(--text)); }
    .err{ color:#ef4444; white-space:pre-wrap; font-family:var(--mono); font-size:12px; }

    /* Dropzone + tables */
    .drop{
      border:1.5px dashed color-mix(in oklab, var(--accent) 28%, var(--border));
      border-radius: 16px;
      padding: 14px;
      background: linear-gradient(135deg,
        color-mix(in oklab, var(--accent) 8%, var(--card)),
        color-mix(in oklab, var(--accent) 3%, var(--card))
      );
      color: var(--muted);
      font-size: 13px;
    }
    .drop strong{ color:var(--text); }
    .list{ display:flex; flex-direction:column; gap:8px; }
    .item{
      border:2px solid var(--border);
      border-radius: 16px;
      padding: 10px 12px;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background: color-mix(in oklab, var(--card) 96%, transparent);
      transition: border-color .2s ease, transform .06s ease;
    }
    .item:hover{ border-color: color-mix(in oklab, var(--accent) 35%, var(--border)); }
    .item:active{ transform: translateY(1px); }
    .item.active{
      border-color: color-mix(in oklab, var(--accent) 45%, var(--border));
      box-shadow: 0 0 0 3px color-mix(in oklab, var(--accent) 18%, transparent);
      background: linear-gradient(135deg,
        color-mix(in oklab, var(--accent) 10%, var(--card)),
        color-mix(in oklab, var(--accent) 4%, var(--card))
      );
    }
    .meta{ font-size:12px; color:var(--muted); }
    .mono{ font-family:var(--mono); }

    /* Tabs */
    .tabs{ display:flex; gap:8px; align-items:center; }
    .tab{
      padding: 9px 11px;
      border-radius: 12px;
      border:2px solid var(--border);
      cursor:pointer;
      font-size:13px;
      background: color-mix(in oklab, var(--card) 96%, transparent);
      user-select:none;
    }
    .tab.active{
      border-color: color-mix(in oklab, var(--accent) 45%, var(--border));
      background: linear-gradient(135deg,
        color-mix(in oklab, var(--accent) 12%, var(--card)),
        color-mix(in oklab, var(--accent) 5%, var(--card))
      );
    }

    /* Table */
    table{ width:100%; border-collapse:separate; border-spacing:0; font-size:13px; }
    th, td{
      border-bottom:1px solid color-mix(in oklab, var(--border) 70%, transparent);
      padding: 9px 10px;
      text-align:left;
      vertical-align:top;
      max-width: 360px;
      word-break: break-word;
    }
    thead th{
      position:sticky; top:0; z-index:2;
      background: color-mix(in oklab, var(--card) 92%, transparent);
      border-bottom:1px solid var(--border);
    }
    .tableWrap{
      overflow:auto;
      border:2px solid var(--border);
      border-radius: 16px;
      background: color-mix(in oklab, var(--card) 97%, transparent);
    }

    /* Inputs */
    textarea{
      width:100%;
      min-height: 160px;
      resize: vertical;
      border:2px solid var(--border);
      border-radius: 16px;
      padding: 12px;
      font-family: var(--mono);
      font-size: 13px;
      background: color-mix(in oklab, var(--card) 97%, transparent);
      color: var(--text);
      outline: none;
    }
    textarea:focus{
      border-color: color-mix(in oklab, var(--accent) 45%, var(--border));
      box-shadow: 0 0 0 3px color-mix(in oklab, var(--accent) 18%, transparent);
    }

    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 980px){
      .grid2{ grid-template-columns: 1fr; }
    }

    .split{
      display:grid;
      grid-template-rows: auto 1fr auto;
      min-height:0;
    }

    .pager{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 10px 14px;
      border-top:1px solid var(--border);
      background: color-mix(in oklab, var(--card) 92%, transparent);
    }
    .pager .center{ display:flex; align-items:center; gap:10px; justify-content:center; flex: 1; }
    .selectLike{
      border:2px solid var(--border);
      border-radius: 12px;
      padding: 8px 10px;
      background: color-mix(in oklab, var(--card) 96%, transparent);
      font-size: 12px;
      cursor:pointer;
      color: var(--text);
    }

    .kbd{
      font-family: var(--mono);
      font-size: 12px;
      padding: 2px 6px;
      border-radius: 8px;
      border:2px solid var(--border);
      background: color-mix(in oklab, var(--card) 90%, transparent);
      color: var(--muted);
    }
  
    .frame{
      border:2px solid color-mix(in oklab, var(--border) 85%, transparent);
      border-radius: 22px;
      background: color-mix(in oklab, var(--card) 92%, transparent);
      box-shadow: 0 10px 26px rgba(2,6,23,.05);
      overflow:hidden;
    }
    .frameHeader{
      padding: 10px 14px;
      border-bottom:1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background: color-mix(in oklab, var(--card) 94%, transparent);
    }
    .frameTitle{
      font-weight: 700;
      font-size: 13px;
      letter-spacing: .2px;
      color: var(--text);
      display:flex;
      align-items:center;
      gap:10px;
    }
    .frameTitle .dot{
      width:10px; height:10px; border-radius:999px;
      background: color-mix(in oklab, var(--accent) 70%, #22c55e);
      box-shadow: 0 0 0 4px color-mix(in oklab, var(--accent) 18%, transparent);
    }

  
    /* Sidebar: Tabellenliste nicht endlos wachsen lassen */
    #tableList{
      max-height: 220px;          /* ~3 Einträge sichtbar (je nach Zeilenhöhe) */
      overflow: auto;
      padding-right: 6px;
      scrollbar-gutter: stable;
    }

  
    /* Vereinfachung: nur SQL-Konsole nutzen */
    #tabView{ display:none !important; }
    #viewMode{ display:none !important; }
    #sqlMode{ display:block !important; }

    /* SQL-Konsole kompakter, dafür größere Schrift */
    #sqlInput{
      min-height: 220px;
      max-height: 340px;
      font-size: 15px;
      line-height: 1.35;
    }

  
    /* SQL-Highlighting (Overlay) */
    .editorWrap{
      position: relative;
      border:1px solid var(--border);
      border-radius: 16px;
      background: color-mix(in oklab, var(--card) 97%, transparent);
      overflow:hidden;
    }
    .sqlHighlight{
      position:absolute;
      inset:0;
      margin:0;
      padding: 12px;
      font-family: var(--mono);
      font-size: 15px;
      line-height: 1.35;
      white-space: pre-wrap;
      word-break: break-word;
      color: var(--text);
      pointer-events:none;
    }
    .sqlHighlight .kw{ color: color-mix(in oklab, var(--accent) 85%, #60a5fa); font-weight: 750; }
    .sqlHighlight .str{ color: color-mix(in oklab, var(--accent2) 80%, #34d399); }
    .sqlHighlight .num{ color: color-mix(in oklab, #f59e0b 75%, var(--text)); }
    /* textarea liegt oben, Text unsichtbar, aber Cursor sichtbar */
    .editorWrap textarea{
      position:relative;
      z-index:1;
      width:100%;
      min-height: 110px;
      max-height: 170px;
      resize: vertical;
      border:0;
      border-radius: 0;
      padding: 12px;
      font-family: var(--mono);
      font-size: 15px;
      line-height: 1.35;
      background: transparent;
      color: transparent;
      caret-color: var(--text);
      outline:none;
    }
    .editorWrap textarea::selection{
      background: color-mix(in oklab, var(--accent) 22%, transparent);
    }

  
    
    /* Ergebnisbereich: zuverlässiges Scrollen innerhalb der Tabelle */
    #resultPanel{ min-height:0; }
    #resultPanel .content{
      flex:1;
      min-height:0;
      display:flex;
      flex-direction:column;
      overflow:hidden; /* Scroll übernimmt die .tableWrap */
    }
    #resultPanel #viewResult,
    #resultPanel #sqlResult{
      flex:1;
      min-height:0;
      display:flex;
      flex-direction:column;
      overflow:hidden;
    }
    #resultPanel .tableWrap{
      flex:1;
      min-height:0;
      height:100%;
      overflow:auto;
      overscroll-behavior: contain;
    }

  
    /* Ergebnis-Pager: Buttons nicht am Rand abschneiden */
    #resultPanel .pager{
      padding-bottom: 16px;
      padding-top: 12px;
    }
    #resultPanel .pager .btn{
      margin-bottom: 2px;
    }

  
    /* Pager: Buttons auffälliger + nicht abschneiden */
    .pager{
      padding: 12px 18px 22px;
    }
    #pagerNav .btn{
      padding: 10px 12px;
      font-size: 14px;
      border-radius: 14px;
    }

  
    /* Ergebnisbereich: nichts am Rand abschneiden */
    #resultPanel{
      overflow: visible;
    }
    #resultPanel .pager{
      padding: 12px 18px 18px;
      min-height: 56px;
    }
    #pagerNav{
      align-items:center;
    }


    /* ========= KOMPAKT-MODUS (nur Abstände/Größen) ========= */

/* global etwas kleiner */
body{ font-size: 14px; }
:root{
  --radius: 14px;               /* vorher 18 */
}

/* Topbar kompakter */
.bar{
  padding: 10px 14px;           /* vorher 14px 22px */
  gap: 10px;
}
.brand h1{ font-size: 14px; }
.brand .sub{ font-size: 11.5px; }
.logo{ width: 32px; height: 32px; border-radius: 10px; }

/* Buttons kompakter */
.btn{
  padding: 8px 10px;            /* vorher 10px 12px */
  font-size: 12.5px;
  border-radius: 10px;
  border-width: 1.5px;          /* vorher 2px */
}
.btn.small{
  padding: 7px 9px;
  font-size: 12px;
  border-radius: 10px;
}

/* Layout: weniger “Luft” */
.wrap{
  padding: 10px 14px 14px;      /* vorher 14px 22px 18px */
  gap: 10px;                    /* vorher 14px */
  grid-template-columns: 300px 1fr; /* Sidebar etwas schmaler (optional) */
}

/* Panels kompakter */
.panel{
  border-width: 1.5px;          /* vorher 2px */
  border-radius: 14px;
}
.panel .top{
  padding: 10px 12px;           /* vorher 12px 14px */
}
.panel .content{
  padding: 10px 12px;           /* vorher 12px 14px */
}

/* Sidebar: Dropzone + Items kompakter */
.drop{
  padding: 12px;                /* vorher 14px */
  border-radius: 14px;
  font-size: 12.5px;
}
.item{
  padding: 8px 10px;            /* vorher 10px 12px */
  border-radius: 14px;
  border-width: 1.5px;
}
.meta{ font-size: 11.5px; }

/* Table kompakter */
th, td{
  padding: 7px 8px;             /* vorher 9px 10px */
  font-size: 12.5px;
}
thead th{
  top: 0;
}

/* SQL Editor kompakter */
.editorWrap{
  border-radius: 14px;
}
.sqlHighlight{
  padding: 10px;
  font-size: 14px;              /* vorher 15px */
  line-height: 1.3;
}
.editorWrap textarea{
  padding: 10px;
  font-size: 14px;
  line-height: 1.3;
  min-height: 96px;             /* vorher 110px */
  max-height: 150px;            /* vorher 170px */
}

/* Pager kompakter */
#resultPanel .pager,
.pager{
  padding: 10px 14px 14px;      /* vorher teils 12/18/22 */
  min-height: 48px;
}

/* Shadows etwas “leichter”, wirkt weniger “aufgeblasen” (optional) */
.panel{
  box-shadow: 0 10px 24px rgba(2,6,23,.06);
}
html[data-theme="dark"] .panel{
  box-shadow: 0 10px 24px rgba(0,0,0,.35);
}

/* === ControlPanel-Kopf (SQL-Konsole + Aktiv-Text) ausblenden === */
#controlPanel > .top{
  display: none !important;
}

/* etwas weniger Innenabstand oben, mehr unten (damit Button nie abgeschnitten ist) */
#controlPanel #mainContent{
  padding-top: 10px !important;
  padding-bottom: 18px !important;
}

/* "SQL eingeben" Zeile ausblenden (optional, spart nochmal Höhe) */
#controlPanel #sqlMode > .status{
  display: none !important;
}

/* Falls der Editor zu hoch gezogen wurde: Resizing deaktivieren (sehr empfehlenswert) */
.editorWrap textarea{
  resize: none !important;
}

/* Panels sollen wachsen, nicht innen scrollen */
.panel .content{
  overflow: visible !important;
}

/* Ergebnisbereich soll komplett wachsen */
#resultPanel .content{
  height: auto !important;
  overflow: visible !important;
}

/* Die Ergebnis-Container sollen ebenfalls wachsen */
#resultPanel #viewResult,
#resultPanel #sqlResult{
  height: auto !important;
  overflow: visible !important;
}

/* TableWrap: nur horizontal scrollen, vertikal soll die Seite scrollen */
#resultPanel .tableWrap{
  height: auto !important;
  max-height: none !important;
  overflow-x: auto !important;
  overflow-y: visible !important;
}

/* === HYBRID: oben bleibt "viewport", unten (Ergebnis) darf wachsen === */
.wrap{
  height: auto !important;                           /* nicht mehr fest */
  min-height: calc(100vh - 68px) !important;         /* wie vorher: mind. Viewport-Höhe */
  grid-template-rows: minmax(0, 1fr) auto !important;/* Zeile1: bleibt im Viewport, Zeile2: wächst */
}

/* oben weiterhin intern scrollen lassen */
#sidePanel .content,
#controlPanel .content{
  overflow: auto !important;
}

/* Ergebnisbereich soll wachsen (kein internes "Zusammenquetschen") */
#resultPanel .content{
  height: auto !important;
  overflow: visible !important;
}

#resultPanel #viewResult,
#resultPanel #sqlResult{
  height: auto !important;
  overflow: visible !important;
}

/* Tabelle: vertikal wächst sie, horizontal darf sie scrollen */
#resultPanel .tableWrap{
  height: auto !important;
  max-height: none !important;
  overflow-x: auto !important;
  overflow-y: visible !important;
}

/* === Cursor/Highlight exakt übereinander ausrichten === */
.editorWrap{
  position: relative;
}

/* Beide Layer: identische Typo + Wrap-Regeln */
.editorWrap .sqlHighlight,
.editorWrap textarea{
  font-family: var(--mono) !important;
  font-size: 14px !important;
  line-height: 1.3 !important;
  padding: 10px !important;

  white-space: pre-wrap !important;
  overflow-wrap: break-word !important;
  word-break: break-word !important;
  tab-size: 2 !important;
}

/* textarea: schreibbar, Cursor sichtbar */
.editorWrap textarea{
  color: transparent !important;
  caret-color: var(--text) !important;
  background: transparent !important;

  /* wichtig: gleiche Scrollbar-Reserve wie beim Highlight */
  overflow: auto !important;
  scrollbar-gutter: stable both-edges !important;
}

/* Highlight: ebenfalls Scrollbar-Reserve, damit Zeilenumbrüche identisch bleiben */
.editorWrap .sqlHighlight{
  overflow: auto !important;
  scrollbar-gutter: stable both-edges !important;
}

/* ===== Schriftgröße steuerbar (per + / - Buttons) ===== */
:root{
  --fs: 14px;        /* Basis-Schrift */
  --fsSmall: 13px;   /* kleinere UI-Texte (Meta/Tabellen) */
  --fsMono: 14px;    /* Editor (SQL) */
}

/* Basis */
body{ font-size: var(--fs) !important; }

/* kleinere UI-Texte */
.status, .meta, .pill, .brand .sub{
  font-size: var(--fsSmall) !important;
}

/* Tabellen */
th, td{
  font-size: var(--fsSmall) !important;
}

/* Buttons (damit +/− nicht “fremd” wirkt) */
.btn{
  font-size: var(--fsSmall) !important;
}

/* SQL Editor / Highlight-Layer */
.editorWrap .sqlHighlight,
.editorWrap textarea{
  font-size: var(--fsMono) !important;
  line-height: 1.3 !important;
}


  </style>
</head>
<body>

<header>
  <div class="bar">
    <div class="brand" aria-label="SQL Nexus">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <h1>SQL Nexus</h1>
        <div class="sub">CSV einlesen → Tabellen ansehen → SQL ausführen</div>
      </div>
    </div>
    <div class="actions">
      <label class="btn primary" for="fileInput" title="CSV-Dateien importieren">Datei(en) laden</label>
      <input id="fileInput" type="file" accept=".csv,.xlsx,text/csv,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/vnd.ms-excel" multiple />
            <button class="btn" id="themeBtn" title="Darstellung wechseln">Dark Mode</button>
            <button class="btn" id="fontDecBtn" title="Text kleiner">−</button>
            <button class="btn" id="fontIncBtn" title="Text größer">+</button>

<button class="btn danger" id="resetBtn" title="Alle Tabellen aus der In‑Browser‑DB löschen">Alles löschen</button>
    </div>
  </div>
</header>

<div class="wrap">
  <!-- Sidebar -->
  <section class="panel frame" id="sidePanel" aria-label="Tabellenübersicht">
    <div class="top">
      <div class="title">Tabellen</div>
      <div class="pill" id="dbStatus">DB: lädt…</div>
    </div>
    <div class="content">
      <div class="drop" id="dropZone">
        <strong>Datei hier ablegen</strong> oder oben über <span class="kbd">Datei(en) laden</span> auswählen.
        <div style="height:6px"></div>
</div>

      <div style="height:12px"></div>

      <div class="list" id="tableList"></div>

      <div style="height:14px"></div>
      
    </div>
  </section>

  <!-- Main -->
  <section class="panel frame split" id="controlPanel" aria-label="SQL Befehle">
    <div class="top">
      <div class="tabs" role="tablist" aria-label="Ansichten">
        <div class="tab" id="tabView" role="tab" aria-selected="false">Tabelle ansehen</div>
        <div class="tab active" id="tabSql" role="tab" aria-selected="true">SQL-Konsole</div>
      </div>
      <div class="status" id="activeInfo">Keine Tabelle ausgewählt.</div>
    </div>

    <div class="content" id="mainContent">
      <!-- VIEW MODE (nur Befehle/Controls) -->
      <div id="viewMode">
        <div style="display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap; align-items:flex-end;">
          <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
            <button class="btn small" id="refreshViewBtn">Neu laden</button>
            <button class="btn small" id="copyCreateBtn" title="CREATE TABLE anzeigen/kopieren">Schema</button>
          </div>

          <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
            <span class="status">Zeilen pro Seite</span>
            <select id="pageSizeSel" class="selectLike" aria-label="Zeilen pro Seite">
              <option>50</option>
              <option selected>100</option>
              <option>200</option>
              <option>500</option>
            </select>
          </div>
        </div>

        <div style="height:10px"></div>
        <div class="status">Wähle links eine Tabelle aus. Die Daten erscheinen unten in der Ergebnistabelle.</div>
      </div>

      <!-- SQL MODE (nur Befehle/Controls) -->
      <div id="sqlMode" style="display:none;">
        <div class="status">SQL eingeben</div>
        <div class="editorWrap">
              <pre id="sqlHighlight" class="sqlHighlight" aria-hidden="true"></pre>
              <textarea id="sqlInput" placeholder="Beispiel:
SELECT *
FROM deine_tabelle;"></textarea>
            </div>

        <div style="height:10px"></div>

        <div style="display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap; align-items:center;">
          <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
            <button class="btn primary" id="runSqlBtn" title="SQL ausführen (SQLite in deinem Browser)">SQL ausführen</button>
</div>

          <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
            <span class="status">Zeilen pro Seite</span>
            <select id="sqlPageSizeSel" class="selectLike" aria-label="SQL Ergebnis: Zeilen pro Seite">
              <option>50</option>
              <option selected>100</option>
              <option>200</option>
              <option>500</option>
            </select>
          </div>
        </div>

        <div id="sqlMsg" class="err" style="margin-top:10px;"></div>
      </div>
    </div>
  </section>

  <!-- Result panel (breit) -->
  <section class="panel frame" id="resultPanel" aria-label="Ergebnistabelle">
    <div class="top">
      <div class="title">Ergebnistabelle</div>
      <div class="status" id="resultInfo">—</div>
    </div>

    <div class="content" style="padding-top:12px;">
      <!-- Table view result -->
      <div id="viewResult">
        <div class="tableWrap">
          <table id="dataTable" aria-label="Tabellenanzeige">
            <thead><tr id="theadRow"></tr></thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>

      <!-- SQL result -->
      <div id="sqlResult" style="display:none;">
        <div class="tableWrap">
          <table aria-label="SQL Ergebnis-Tabelle">
            <thead><tr id="sqlThead"></tr></thead>
            <tbody id="sqlTbody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Pager -->
    <div class="pager" aria-label="Pagination">
      <div id="pagerNav" style="display:flex; gap:10px;">
        <button class="btn small primary" id="prevBtn" title="Vorherige Seite">←</button>
        <button class="btn small primary" id="nextBtn" title="Nächste Seite">→</button>
      </div>
      <div class="center">
        <span class="status" id="pageLabel">Seite 1</span>
      </div>
      <div class="status" style="min-width: 180px; text-align:right;"></div>
    </div>
  </section>
</div>

<!-- PapaParse -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<!-- SheetJS (XLSX) -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<!-- sql.js (SQLite in WASM) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.2/sql-wasm.js"></script>

<script>
  let SQL = null;
  let db = null;

  // UI state
  let activeTable = null;
  let mode = "sql"; // view | sql

  // paging for table view
  let page = 0;
  let pageSize = 100;
  let totalRows = 0;

  // paging for sql result
  let sqlPage = 0;
  let sqlPageSize = 100;
  let sqlTotalRows = 0;
  let lastSql = "";

  const $ = (id) => document.getElementById(id);
  
  // ---------- Layout helper: Ergebnisbereich zuverlässig scrollbar ----------
  function layoutResultPanel(){
    return; 
  }


  
  function updatePagerUI(){
    const nav = $("pagerNav");
    const prev = $("prevBtn");
    const next = $("nextBtn");
    if(!nav || !prev || !next) return;

    const maxPage = Math.max(0, Math.ceil(sqlTotalRows / sqlPageSize) - 1);
    const hasPages = (maxPage > 0);

    nav.style.display = hasPages ? "flex" : "none";

    // Disable at edges (visually clearer)
    prev.disabled = (sqlPage <= 0);
    next.disabled = (sqlPage >= maxPage);
  }
//window.addEventListener("resize", () => {
    // avoid layout thrash
   // requestAnimationFrame(layoutResultPanel);
 // });

  // ---------- SQL Highlighting ----------
  const SQL_KEYWORDS = [
    "SELECT","FROM","WHERE","JOIN","INNER","LEFT","RIGHT","FULL","OUTER","ON","AS",
    "GROUP","BY","HAVING","ORDER","LIMIT","OFFSET","AND","OR","NOT","IN","IS","NULL",
    "DISTINCT","UNION","ALL","INSERT","INTO","VALUES","UPDATE","SET","DELETE",
    "CREATE","TABLE","DROP","ALTER","ADD","PRIMARY","KEY","FOREIGN","REFERENCES"
  ];

  function escapeHtml(s){
    return s.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
  }

  function highlightSql(text){
    // Very simple highlighter: keywords, numbers, single-quoted strings
    let out = "";
    let i = 0;

    const isWordStart = (c) => /[A-Za-z_]/.test(c);
    const isWord = (c) => /[A-Za-z0-9_]/.test(c);

    while(i < text.length){
      const ch = text[i];

      // strings in single quotes
      if(ch === "'"){
        let j = i + 1;
        while(j < text.length){
          if(text[j] === "'"){ j++; break; }
          j++;
        }
        const str = text.slice(i, j);
        out += `<span class="str">${escapeHtml(str)}</span>`;
        i = j;
        continue;
      }

      // numbers
      if(/[0-9]/.test(ch)){
        let j = i + 1;
        while(j < text.length && /[0-9.]/.test(text[j])) j++;
        const num = text.slice(i, j);
        out += `<span class="num">${escapeHtml(num)}</span>`;
        i = j;
        continue;
      }

      // words/keywords
      if(isWordStart(ch)){
        let j = i + 1;
        while(j < text.length && isWord(text[j])) j++;
        const word = text.slice(i, j);
        const up = word.toUpperCase();
        if(SQL_KEYWORDS.includes(up)){
          out += `<span class="kw">${escapeHtml(up)}</span>`;
        }else{
          out += escapeHtml(word);
        }
        i = j;
        continue;
      }

      // other chars
      out += escapeHtml(ch);
      i++;
    }

    return out + (text.endsWith("\n") ? "\n" : "");
  }

  function updateSqlHighlight(){
    const ta = $("sqlInput");
    const pre = $("sqlHighlight");
    if(!ta || !pre) return;
    pre.innerHTML = highlightSql(ta.value);
    // sync scroll positions
    pre.scrollTop = ta.scrollTop;
    pre.scrollLeft = ta.scrollLeft;
  }


  
  // ---------- Theme (Light/Dark toggle) ----------
  function applyTheme(theme){
    document.documentElement.setAttribute("data-theme", theme);
    try{ localStorage.setItem("sql_nexus_theme", theme); }catch(e){}
    const btn = $("themeBtn");
    if(btn){
      btn.textContent = theme === "dark" ? "Light Mode" : "Dark Mode";
    }
  }
  function initTheme(){
    let theme = "light";
    try{
      const saved = localStorage.getItem("sql_nexus_theme");
      if(saved === "dark" || saved === "light") theme = saved;
    }catch(e){}
    applyTheme(theme);
  }
function setStatus(text, ok=false){
    const el = $("dbStatus");
    el.textContent = text;
    el.className = "pill " + (ok ? "ok" : "");
  }

  // Initialize DB
  async function init(){
    try{
      SQL = await initSqlJs({
        locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.2/${file}`
      });
      db = new SQL.Database();
      setStatus("DB: bereit", true);
    }catch(e){
      setStatus("DB: Fehler");
      console.error(e);
      alert("sql.js konnte nicht geladen werden. Prüfe Internetzugang oder Content-Security-Policy.");
    }
  }

  // ---------- Helpers ----------
  function sanitizeTableName(filename){
    // remove extension, keep alnum + underscore, replace others with _
    const base = filename.replace(/\.[^/.]+$/, "");
    return base.replace(/[^a-zA-Z0-9_äöüÄÖÜß]/g, "_");
  }

  function quoteIdent(name){
    // SQLite identifier quoting
    return `"${String(name).replaceAll('"','""')}"`;
  }

  function exec(sql){
    return db.exec(sql);
  }

  function listTables(){
    const res = exec(`SELECT name FROM sqlite_master WHERE type='table' AND name NOT LIKE 'sqlite_%' ORDER BY name;`);
    if(!res.length) return [];
    return res[0].values.map(v => v[0]);
  }

  function getTableInfo(t){
    const res = exec(`SELECT COUNT(*) AS cnt FROM ${quoteIdent(t)};`);
    const cnt = res.length ? res[0].values[0][0] : 0;
    const cols = exec(`PRAGMA table_info(${quoteIdent(t)});`)[0]?.values?.map(r => r[1]) ?? [];
    return { cnt, cols };
  }

  function renderTableList(){
    const list = $("tableList");
    list.innerHTML = "";
    const tables = listTables();
    if(!tables.length){
      list.innerHTML = `<div class="status">Noch keine Tabellen geladen.</div>`;
      return;
    }
    for(const t of tables){
      const info = getTableInfo(t);
      const div = document.createElement("div");
      div.className = "item" + (t === activeTable ? " active" : "");
      div.innerHTML = `
        <div>
          <div class="mono" style="font-weight:650;">${t}</div>
          <div class="meta">${info.cnt} Zeilen · ${info.cols.length} Spalten</div>
        </div>
        <div class="meta">›</div>
      `;
      div.onclick = () => {
        activeTable = t;
        page = 0;
        renderTableList();
        updateActiveInfo();
        if(mode === "view") renderActiveTable();
      };
      list.appendChild(div);
    }
  }

  function updateActiveInfo(){
    $("activeInfo").textContent = activeTable
      ? `Aktiv: ${activeTable}`
      : "Keine Tabelle ausgewählt.";
    updateResultInfo();
    layoutResultPanel();
}

  function updateResultInfo(){
    const el = $("resultInfo");
    if(!el) return;
    if(mode === "view"){
      el.textContent = activeTable ? `Tabelle: ${activeTable}` : "Keine Tabelle ausgewählt.";
    }else{
      el.textContent = lastSql ? "SQL-Ergebnis" : "Noch keine Abfrage ausgeführt.";
    }
  }

  function setMode(next){
    mode = next;
    $("tabView").classList.toggle("active", mode==="view");
    $("tabSql").classList.toggle("active", mode==="sql");
    $("tabView").setAttribute("aria-selected", mode==="view" ? "true" : "false");
    $("tabSql").setAttribute("aria-selected", mode==="sql" ? "true" : "false");

    $("viewMode").style.display = mode==="view" ? "block" : "none";
    $("sqlMode").style.display = mode==="sql" ? "block" : "none";

    // Ergebnisbereich passend umschalten
    $("viewResult").style.display = mode==="view" ? "flex" : "none";
    $("sqlResult").style.display = mode==="sql" ? "flex" : "none";
    updateResultInfo();

    // reset pager label
    if(mode==="view"){
      $("pageLabel").textContent = `Seite ${page+1}`;
      renderActiveTable();
    }else{
      $("pageLabel").textContent = `Seite ${sqlPage+1}`;
                  updatePagerUI();
      layoutResultPanel();
updatePagerUI();
      layoutResultPanel();
renderSqlResultPage();
    }
  }

  // ---------- Table view rendering (paged) ----------
  function renderActiveTable(){
    if(!activeTable){
      $("theadRow").innerHTML = "";
      $("tbody").innerHTML = `<tr><td class="status">Bitte links eine Tabelle auswählen.</td></tr>`;
      totalRows = 0;
      $("pageLabel").textContent = "Seite 1";
      return;
    }

    // total rows
    totalRows = exec(`SELECT COUNT(*) FROM ${quoteIdent(activeTable)};`)[0].values[0][0];

    const offset = page * pageSize;
    const res = exec(`SELECT * FROM ${quoteIdent(activeTable)} LIMIT ${pageSize} OFFSET ${offset};`);
    const cols = res[0]?.columns ?? [];
    const rows = res[0]?.values ?? [];

    // header
    $("theadRow").innerHTML = cols.map(c => `<th class="mono">${c}</th>`).join("");

    // body
    const tbody = $("tbody");
    tbody.innerHTML = "";
    if(!rows.length){
      tbody.innerHTML = `<tr><td class="status" colspan="${Math.max(cols.length,1)}">Keine Daten auf dieser Seite.</td></tr>`;
    }else{
      const frag = document.createDocumentFragment();
      for(const r of rows){
        const tr = document.createElement("tr");
        tr.innerHTML = r.map(v => `<td>${v === null ? "<span class='status'>NULL</span>" : String(v)}</td>`).join("");
        frag.appendChild(tr);
      }
      tbody.appendChild(frag);
    }

    $("pageLabel").textContent = `Seite ${page+1} · Zeilen ${Math.min(offset+1, totalRows)}–${Math.min(offset+pageSize, totalRows)} von ${totalRows}`;
    layoutResultPanel();
  }

  // ---------- SQL execution + paged result ----------
  function stripSqlComments(sql){
    // remove -- line comments (simple)
    return sql.split("\n").filter(line => !line.trim().startsWith("--")).join("\n");
  }

  function splitTail(tail){
    // Splits tail into wherePart + endPart (ORDER BY / GROUP BY / LIMIT / etc.)
    // Very pragmatic, classroom-friendly parser.
    const t = (tail || "").trim();
    if(!t) return { wherePart: "", endPart: "" };

    const lower = t.toLowerCase();
    const whereIdx = lower.indexOf("where ");
    const clauseKeywords = [" group by ", " having ", " order by ", " limit ", " offset "];
    const firstClauseIdx = clauseKeywords
      .map(k => lower.indexOf(k))
      .filter(i => i >= 0)
      .sort((a,b)=>a-b)[0];

    if(whereIdx >= 0){
      const afterWhere = whereIdx + "where ".length;
      const endIdx = (firstClauseIdx !== undefined && firstClauseIdx >= 0) ? firstClauseIdx : t.length;
      const wherePart = t.slice(afterWhere, endIdx).trim();
      const endPart = t.slice(endIdx).trim();
      return { wherePart, endPart };
    }

    // No WHERE: everything is an endPart
    return { wherePart: "", endPart: t };
  }

  function tryRewriteFullOuter(sql){
    // Rewrite a common FULL OUTER JOIN pattern into UNION ALL (SQLite-safe).
    // Keeps user aliases where possible.
    const s = sql;

    const m = s.match(/select\s+([\s\S]+?)\s+from\s+([a-zA-Z0-9_"]+)(?:\s+(?:as\s+)?([a-zA-Z0-9_"]+))?\s+full\s+outer\s+join\s+([a-zA-Z0-9_"]+)(?:\s+(?:as\s+)?([a-zA-Z0-9_"]+))?\s+on\s+([a-zA-Z0-9_".]+)\s*=\s*([a-zA-Z0-9_".]+)([\s\S]*)/i);
    if(!m) return sql;

    const selectPart = m[1].trim();
    const A = m[2].trim();
    const Aalias = (m[3] || "").trim();
    const B = m[4].trim();
    const Balias = (m[5] || "").trim();
    const leftKey = m[6].trim();
    const rightKey = m[7].trim();
    const tail = (m[8] || "").trim();

    const Aref = Aalias ? `${A} AS ${Aalias}` : A;
    const Bref = Balias ? `${B} AS ${Balias}` : B;

    const { wherePart, endPart } = splitTail(tail);

    const q1 = `
SELECT ${selectPart}
FROM ${Aref} LEFT JOIN ${Bref} ON ${leftKey} = ${rightKey}
${wherePart ? `WHERE ${wherePart}` : ""}
`.trim();

    const q2 = `
SELECT ${selectPart}
FROM ${Bref} LEFT JOIN ${Aref} ON ${rightKey} = ${leftKey}
WHERE ${leftKey} IS NULL
${wherePart ? `AND (${wherePart})` : ""}
`.trim();

    const rewritten = `${q1}
UNION ALL
${q2}
${endPart ? endPart : ""}`.trim();

    return rewritten;
  }

  function tryRewriteRightJoin(sql){
    // Rewrite a common RIGHT JOIN pattern into LEFT JOIN by swapping tables.
    const s = sql;
    const m = s.match(/select\s+([\s\S]+?)\s+from\s+([a-zA-Z0-9_"]+)(?:\s+(?:as\s+)?([a-zA-Z0-9_"]+))?\s+right\s+join\s+([a-zA-Z0-9_"]+)(?:\s+(?:as\s+)?([a-zA-Z0-9_"]+))?\s+on\s+([a-zA-Z0-9_".]+)\s*=\s*([a-zA-Z0-9_".]+)([\s\S]*)/i);
    if(!m) return sql;

    const selectPart = m[1].trim();
    const A = m[2].trim();
    const Aalias = (m[3] || "").trim();
    const B = m[4].trim();
    const Balias = (m[5] || "").trim();
    const leftKey = m[6].trim();
    const rightKey = m[7].trim();
    const tail = (m[8] || "").trim();

    const Aref = Aalias ? `${A} AS ${Aalias}` : A;
    const Bref = Balias ? `${B} AS ${Balias}` : B;

    // RIGHT JOIN: A RIGHT JOIN B ON A.k = B.k  ==>  B LEFT JOIN A ON B.k = A.k
    const rewritten = `
SELECT ${selectPart}
FROM ${Bref} LEFT JOIN ${Aref} ON ${rightKey} = ${leftKey}
${tail ? tail : ""}
`.trim();

    return rewritten;
  }

  function runSql(){
    $("sqlMsg").textContent = "";
    const raw = $("sqlInput").value;
    let sql = stripSqlComments(raw).trim();
    if(!sql){
      $("sqlMsg").textContent = "Bitte SQL eingeben.";
      return;
    }

    // Pragmatic JOIN rewrites for SQLite/sql.js (falls nicht unterstützt)
    if(/full\s+outer\s+join/i.test(sql)){
      sql = tryRewriteFullOuter(sql);
    }
    if(/right\s+join/i.test(sql)){
      sql = tryRewriteRightJoin(sql);
    }

    try{
      // Count total rows for pagination
      // Wrap as subquery:
      const countSql = `SELECT COUNT(*) AS cnt FROM (${sql}) AS __q;`;
      const cnt = exec(countSql)[0].values[0][0];
      sqlTotalRows = cnt;
      lastSql = sql;
      sqlPage = 0;
      updateResultInfo();
      renderSqlResultPage();
          updatePagerUI();
      layoutResultPanel();
}catch(e){
      console.error(e);
      $("sqlMsg").textContent = String(e);
    }
  }

  function renderSqlResultPage(){
    if(!lastSql){
      $("sqlThead").innerHTML = "";
      $("sqlTbody").innerHTML = `<tr><td class="status">Noch keine SQL-Abfrage ausgeführt.</td></tr>`;
      $("pageLabel").textContent = "Seite 1";
      return;
    }
    const offset = sqlPage * sqlPageSize;

    try{
      const pageSql = `SELECT * FROM (${lastSql}) AS __q LIMIT ${sqlPageSize} OFFSET ${offset};`;
      const res = exec(pageSql);
      const cols = res[0]?.columns ?? [];
      const rows = res[0]?.values ?? [];

      $("sqlThead").innerHTML = cols.map(c => `<th class="mono">${c}</th>`).join("");
      const tb = $("sqlTbody");
      tb.innerHTML = "";

      if(!rows.length){
        tb.innerHTML = `<tr><td class="status" colspan="${Math.max(cols.length,1)}">Keine Daten auf dieser Seite.</td></tr>`;
      }else{
        const frag = document.createDocumentFragment();
        for(const r of rows){
          const tr = document.createElement("tr");
          tr.innerHTML = r.map(v => `<td>${v === null ? "<span class='status'>NULL</span>" : String(v)}</td>`).join("");
          frag.appendChild(tr);
        }
        tb.appendChild(frag);
      }

      $("pageLabel").textContent =
        `Seite ${sqlPage+1} · Zeilen ${Math.min(offset+1, sqlTotalRows)}–${Math.min(offset+sqlPageSize, sqlTotalRows)} von ${sqlTotalRows}`;
      layoutResultPanel();
    }catch(e){
      console.error(e);
      $("sqlMsg").textContent = String(e);
    }
  }

  // ---------- CSV Import ----------
  async function importCsvFile(file){
    const tableName = sanitizeTableName(file.name);

    // parse with PapaParse (worker + fast)
    const parsed = await new Promise((resolve, reject) => {
      Papa.parse(file, {
        header: true,
        skipEmptyLines: true,
        worker: true,
        dynamicTyping: false,
        complete: (results) => resolve(results),
        error: (err) => reject(err),
      });
    });

    if(!parsed.data?.length){
      throw new Error(`Keine Daten in ${file.name} gefunden.`);
    }

    const cols = parsed.meta.fields || Object.keys(parsed.data[0] || {});
    if(!cols.length) throw new Error(`Keine Spaltenüberschriften in ${file.name} gefunden.`);

    // Drop if exists
    exec(`DROP TABLE IF EXISTS ${quoteIdent(tableName)};`);

    // Create table as TEXT columns
    const colDefs = cols.map(c => `${quoteIdent(c)} TEXT`).join(", ");
    exec(`CREATE TABLE ${quoteIdent(tableName)} (${colDefs});`);

    // Prepare insert
    const placeholders = cols.map(() => "?").join(",");
    const stmt = db.prepare(`INSERT INTO ${quoteIdent(tableName)} (${cols.map(quoteIdent).join(",")}) VALUES (${placeholders});`);

    db.run("BEGIN TRANSACTION;");
    for(const row of parsed.data){
      const values = cols.map(c => {
        const v = row[c];
        return (v === undefined || v === null || String(v).trim() === "") ? null : String(v);
      });
      stmt.run(values);
    }
    stmt.free();
    db.run("COMMIT;");

    return tableName;
  }

async function importXlsxFile(file){
  const buf = await file.arrayBuffer();
  const wb = XLSX.read(buf, { type: "array" });

  const created = [];
  const sheetNames = wb.SheetNames || [];

  for(const sheetName of sheetNames){
    const ws = wb.Sheets[sheetName];
    if(!ws) continue;

    const rows = XLSX.utils.sheet_to_json(ws, { defval: null });
    if(!rows || !rows.length) continue;

    const cols = [];
    const seen = new Set();
    for(const r of rows){
      for(const k of Object.keys(r)){
        if(!seen.has(k)){
          seen.add(k);
          cols.push(String(k));
        }
      }
    }
    if(!cols.length) continue;

    // Tabellenname = Sheetname
    let tableName = sanitizeTableName(String(sheetName));
    if(!tableName) tableName = "Tabelle";

    // Falls schon vorhanden: _2, _3, ...
    const existing = new Set(listTables());
    if(existing.has(tableName)){
      let i = 2;
      while(existing.has(`${tableName}_${i}`)) i++;
      tableName = `${tableName}_${i}`;
    }

    exec(`DROP TABLE IF EXISTS ${quoteIdent(tableName)};`);

    const colDefs = cols.map(c => `${quoteIdent(c)} TEXT`).join(", ");
    exec(`CREATE TABLE ${quoteIdent(tableName)} (${colDefs});`);

    const placeholders = cols.map(() => "?").join(",");
    const stmt = db.prepare(
      `INSERT INTO ${quoteIdent(tableName)} (${cols.map(quoteIdent).join(",")}) VALUES (${placeholders});`
    );

    db.run("BEGIN TRANSACTION;");
    for(const row of rows){
      const values = cols.map(c => {
        const v = row[c];
        if(v === undefined || v === null) return null;
        const s = String(v).trim();
        return s === "" ? null : s;
      });
      stmt.run(values);
    }
    stmt.free();
    db.run("COMMIT;");

    created.push(tableName);
  }

  if(!created.length){
    throw new Error(`Keine Datenblätter in ${file.name} gefunden.`);
  }
  return created;
}



  async function handleFiles(files){
    if(!db){
      alert("DB ist noch nicht bereit.");
      return;
    }
    const arr = Array.from(files || []);
    if(!arr.length) return;

    setStatus(`DB: importiere ${arr.length} Datei(en)…`);
    for(const f of arr){
      try{
        if(/\.(xlsx|xls|ods)$/i.test(f.name)){
          await importXlsxFile(f);
        }else{
          await importCsvFile(f);
        }
      }catch(e){
        console.error(e);
        alert(`Import-Fehler (${f.name}):
${e}`);
      }
    }
    setStatus("DB: bereit", true);
    renderTableList();
    requestAnimationFrame(layoutResultPanel);

    // auto-select first table
    const tables = listTables();
    if(!activeTable && tables.length){
      activeTable = tables[0];
      page = 0;
      updateActiveInfo();
      renderTableList();
      if(mode==="view") renderActiveTable();
    }
  }

  // ---------- UI wiring ----------
  initTheme();
  const themeBtn = $("themeBtn");
  if(themeBtn){
    themeBtn.onclick = () => {
      const cur = document.documentElement.getAttribute("data-theme") || "light";
      applyTheme(cur === "dark" ? "light" : "dark");
    };
  }

  // ---------- Font size (+ / -) ----------
const FONT_STEPS = [13, 14, 15, 16, 17, 18, 19, 20]; // sinnvolle Grenzen
let currentFontPx = 14;

function applyFont(px){
  currentFontPx = px;

  // Variablen setzen
  document.documentElement.style.setProperty("--fs", px + "px");
  document.documentElement.style.setProperty("--fsSmall", Math.max(px - 1, 11) + "px");
  document.documentElement.style.setProperty("--fsMono", px + "px");

  // Buttons an/aus (an den Grenzen)
  const dec = $("fontDecBtn");
  const inc = $("fontIncBtn");
  if(dec) dec.disabled = (px <= FONT_STEPS[0]);
  if(inc) inc.disabled = (px >= FONT_STEPS[FONT_STEPS.length - 1]);

  // merken
  try{ localStorage.setItem("sql_nexus_font_px", String(px)); }catch(e){}
}

function initFont(){
  let px = 14;
  try{
    const saved = parseInt(localStorage.getItem("sql_nexus_font_px"), 10);
    if(FONT_STEPS.includes(saved)) px = saved;
  }catch(e){}

  applyFont(px);

  const dec = $("fontDecBtn");
  const inc = $("fontIncBtn");

  if(dec){
    dec.onclick = () => {
      const i = FONT_STEPS.indexOf(currentFontPx);
      if(i > 0) applyFont(FONT_STEPS[i - 1]);
    };
  }
  if(inc){
    inc.onclick = () => {
      const i = FONT_STEPS.indexOf(currentFontPx);
      if(i >= 0 && i < FONT_STEPS.length - 1) applyFont(FONT_STEPS[i + 1]);
    };
  }
}


  $("fileInput").addEventListener("change", (e) => handleFiles(e.target.files));

  $("resetBtn").onclick = () => {
    if(!db) return;
    const tables = listTables();
    db.run("BEGIN TRANSACTION;");
    for(const t of tables){
      exec(`DROP TABLE IF EXISTS ${quoteIdent(t)};`);
    }
    db.run("COMMIT;");
    activeTable = null;
    page = 0; sqlPage = 0;
    lastSql = "";
    updateResultInfo();
    renderTableList();
    updateActiveInfo();
    renderActiveTable();
    $("sqlThead").innerHTML = "";
    $("sqlTbody").innerHTML = "";
    $("sqlMsg").textContent = "";
  };

  $("tabView").onclick = () => setMode("view");
  $("tabSql").onclick = () => setMode("sql");

  $("pageSizeSel").onchange = () => {
    pageSize = parseInt($("pageSizeSel").value, 10);
    page = 0;
    if(mode==="view") renderActiveTable();
  };

  $("sqlPageSizeSel").onchange = () => {
    sqlPageSize = parseInt($("sqlPageSizeSel").value, 10);
    sqlPage = 0;
    if(mode==="sql") renderSqlResultPage();
      updatePagerUI();
};

  $("prevBtn").onclick = () => {
    if(mode==="view"){
      if(page > 0){ page--; renderActiveTable(); }
    }else{
      if(sqlPage > 0){ sqlPage--; renderSqlResultPage(); } updatePagerUI();
    }
  };
  $("nextBtn").onclick = () => {
    if(mode==="view"){
      const maxPage = Math.max(0, Math.ceil(totalRows / pageSize) - 1);
      if(page < maxPage){ page++; renderActiveTable(); }
    }else{
      const maxPage = Math.max(0, Math.ceil(sqlTotalRows / sqlPageSize) - 1);
      if(sqlPage < maxPage){ sqlPage++; renderSqlResultPage(); } updatePagerUI();
    }
  };

  $("refreshViewBtn").onclick = () => renderActiveTable();

  $("copyCreateBtn").onclick = async () => {
    if(!activeTable) return;
    const info = exec(`PRAGMA table_info(${quoteIdent(activeTable)});`)[0]?.values ?? [];
    const cols = info.map(r => `${quoteIdent(r[1])} TEXT`).join(", ");
    const ddl = `CREATE TABLE ${quoteIdent(activeTable)} (${cols});`;
    try{
      await navigator.clipboard.writeText(ddl);
      alert("Schema kopiert:\n" + ddl);
    }catch(e){
      // fallback: show prompt for manual copy
      prompt("Kopiere das Schema:", ddl);
    }
  };

  $("runSqlBtn").onclick = () => runSql();

  // Highlighting wiring
  const ta = $("sqlInput");
  if(ta){
    ta.addEventListener("input", updateSqlHighlight);
    ta.addEventListener("scroll", updateSqlHighlight);
  }


  // drag & drop
  const dz = $("dropZone");
  dz.addEventListener("dragover", (e)=>{ e.preventDefault(); dz.style.borderColor="color-mix(in oklab, var(--accent) 55%, var(--border))"; });
  dz.addEventListener("dragleave", ()=>{ dz.style.borderColor=""; });
  dz.addEventListener("drop", (e)=>{
    e.preventDefault();
    dz.style.borderColor="";
    handleFiles(e.dataTransfer.files);
  });

  initFont();
  init().then(() => { renderTableList(); setMode("sql"); updateSqlHighlight(); layoutResultPanel(); updatePagerUI(); });

</script>
</body>
</html>
